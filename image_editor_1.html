<!doctype html>
<html>
<head>
    <title>Image Editor Example 2</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link href="style.css" rel="stylesheet" />
    <script src="filters.js"></script>
    <script type="text/javascript">      
        var canvas;
        var loadedImage;

        window.onload = function () {

            setupFilters();

            var canvasContainer = document.getElementById('canvasContainer');
            var downloadHolder = document.getElementById('downloadHolder');
            var uploader = document.getElementById('uploader');

            // Загружаем файл
            uploader.addEventListener('change', function (event) {
                var file = event.target.files[0];
                console.log('file name ' + file.name);
                console.log('file size ' + file.size);
                console.log('file type ' + file.type);
                // Добавляем изображение в canvas
                fileToCanvas(file, canvas);
            });
        };

        function fileToCanvas (file) {
            loadedImage = new Image();
            loadedImage.addEventListener('load', function (event) {
                URL.revokeObjectURL(file);
                if (canvas) {
                    canvas.parentNode.removeChild(canvas);
                }
                canvas = document.createElement('canvas');
                canvas.width = loadedImage.width;
                canvas.height = loadedImage.height;
                canvas.getContext("2d").drawImage(loadedImage, 0, 0);
                canvasContainer.appendChild(canvas);
                
                generateDownloadLink();
            });
            loadedImage.src = URL.createObjectURL(file);
        }
        
        function generateDownloadLink () {
            downloadHolder.innerHTML = '<a href="' + canvas.toDataURL('image/png') + '" download=file.png>DOWNLOAD</a>';
        }
        
        function setupFilters () {
            var buttons = document.getElementsByClassName('filter_button');
            Array.prototype.forEach.call(buttons, function (button) {
                var path = filters[button.dataset.key];
                var img = new Image();
                img.src = path;
                img.onload = function () {
                    button.onclick = function () {
                        setFilter(img);
                    };
                };
                button.style.backgroundImage = 'url("' + path + '")';
            });
        }
        
        function setFilter (filterImg) {
            if (canvas) {
                var ctx = canvas.getContext("2d");
                ctx.drawImage(loadedImage, 0, 0);
                ctx.drawImage(filterImg, 0, 0, filterImg.width, filterImg.height, 0, 0, canvas.width, canvas.height);
                generateDownloadLink();
            }
        }
    </script>
</head>
<body class="page">
    <div class="container">
        <div class=row style="width: 250px;">
            <div class="cell" id="setting">
                <input type=file id=uploader accept="image/*" />
            </div>
            <div class="cell" id="downloadHolder">
                Здесь будет ссылка на скачивание файла
            </div>
        </div>
        <div class=row>
            <div class="cell" id="filters">
                <div class=filter_button data-key="swamp"></div>
                <div class=filter_button data-key="spectre"></div>
                <div class=filter_button data-key="sky"></div>
                <div class=filter_button data-key="orange"></div>
            </div>
            <div class="cell" id="canvasContainer"></div>
        </div>
    </div>
</body>
</html>